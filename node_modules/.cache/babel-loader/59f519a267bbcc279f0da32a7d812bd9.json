{"ast":null,"code":"'use strict';\n\nconst AbstractQuery = require('../abstract/query');\n\nconst sequelizeErrors = require('../../errors');\n\nconst _ = require('lodash');\n\nconst DataTypes = require('../../data-types');\n\nconst {\n  logger\n} = require('../../utils/logger');\n\nconst ER_DUP_ENTRY = 1062;\nconst ER_DEADLOCK = 1213;\nconst ER_ROW_IS_REFERENCED = 1451;\nconst ER_NO_REFERENCED_ROW = 1452;\nconst debug = logger.debugContext('sql:mariadb');\n\nclass Query extends AbstractQuery {\n  constructor(connection, sequelize, options) {\n    super(connection, sequelize, {\n      showWarnings: false,\n      ...options\n    });\n  }\n\n  static formatBindParameters(sql, values, dialect) {\n    const bindParam = [];\n\n    const replacementFunc = (match, key, values_) => {\n      if (values_[key] !== undefined) {\n        bindParam.push(values_[key]);\n        return '?';\n      }\n\n      return undefined;\n    };\n\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n    return [sql, bindParam.length > 0 ? bindParam : undefined];\n  }\n\n  async run(sql, parameters) {\n    this.sql = sql;\n    const {\n      connection,\n      options\n    } = this;\n    const showWarnings = this.sequelize.options.showWarnings || options.showWarnings;\n\n    const complete = this._logQuery(sql, debug, parameters);\n\n    if (parameters) {\n      debug('parameters(%j)', parameters);\n    }\n\n    let results;\n\n    try {\n      results = await connection.query(this.sql, parameters);\n    } catch (error) {\n      if (options.transaction && error.errno === ER_DEADLOCK) {\n        // MariaDB automatically rolls-back transactions in the event of a deadlock.\n        // However, we still initiate a manual rollback to ensure the connection gets released - see #13102.\n        try {\n          await options.transaction.rollback();\n        } catch (error_) {// Ignore errors - since MariaDB automatically rolled back, we're\n          // not that worried about this redundant rollback failing.\n        }\n\n        options.transaction.finished = 'rollback';\n      }\n\n      error.sql = sql;\n      error.parameters = parameters;\n      throw this.formatError(error);\n    } finally {\n      complete();\n    }\n\n    if (showWarnings && results && results.warningStatus > 0) {\n      await this.logWarnings(results);\n    }\n\n    return this.formatResults(results);\n  }\n  /**\n   * High level function that handles the results of a query execution.\n   *\n   *\n   * Example:\n   *  query.formatResults([\n   *    {\n   *      id: 1,              // this is from the main table\n   *      attr2: 'snafu',     // this is from the main table\n   *      Tasks.id: 1,        // this is from the associated table\n   *      Tasks.title: 'task' // this is from the associated table\n   *    }\n   *  ])\n   *\n   * @param {Array} data - The result of the query execution.\n   * @private\n   */\n\n\n  formatResults(data) {\n    let result = this.instance;\n\n    if (this.isBulkUpdateQuery() || this.isBulkDeleteQuery()) {\n      return data.affectedRows;\n    }\n\n    if (this.isUpsertQuery()) {\n      return [result, data.affectedRows === 1];\n    }\n\n    if (this.isInsertQuery(data)) {\n      this.handleInsertQuery(data);\n\n      if (!this.instance) {\n        // handle bulkCreate AI primary key\n        if (this.model && this.model.autoIncrementAttribute && this.model.autoIncrementAttribute === this.model.primaryKeyAttribute && this.model.rawAttributes[this.model.primaryKeyAttribute]) {\n          // ONLY TRUE IF @auto_increment_increment is set to 1 !!\n          // Doesn't work with GALERA => each node will reserve increment (x for first server, x+1 for next node...)\n          const startId = data[this.getInsertIdField()];\n          result = new Array(data.affectedRows);\n          const pkField = this.model.rawAttributes[this.model.primaryKeyAttribute].field;\n\n          for (let i = 0; i < data.affectedRows; i++) {\n            result[i] = {\n              [pkField]: startId + i\n            };\n          }\n\n          return [result, data.affectedRows];\n        }\n\n        return [data[this.getInsertIdField()], data.affectedRows];\n      }\n    }\n\n    if (this.isSelectQuery()) {\n      this.handleJsonSelectQuery(data);\n      return this.handleSelectQuery(data);\n    }\n\n    if (this.isInsertQuery() || this.isUpdateQuery()) {\n      return [result, data.affectedRows];\n    }\n\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n\n    if (this.isRawQuery()) {\n      const meta = data.meta;\n      delete data.meta;\n      return [data, meta];\n    }\n\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n\n    if (this.isForeignKeysQuery() || this.isShowConstraintsQuery()) {\n      return data;\n    }\n\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n\n    if (this.isDescribeQuery()) {\n      result = {};\n\n      for (const _result of data) {\n        result[_result.Field] = {\n          type: _result.Type.toLowerCase().startsWith('enum') ? _result.Type.replace(/^enum/i, 'ENUM') : _result.Type.toUpperCase(),\n          allowNull: _result.Null === 'YES',\n          defaultValue: _result.Default,\n          primaryKey: _result.Key === 'PRI',\n          autoIncrement: Object.prototype.hasOwnProperty.call(_result, 'Extra') && _result.Extra.toLowerCase() === 'auto_increment',\n          comment: _result.Comment ? _result.Comment : null\n        };\n      }\n\n      return result;\n    }\n\n    if (this.isVersionQuery()) {\n      return data[0].version;\n    }\n\n    return result;\n  }\n\n  handleJsonSelectQuery(rows) {\n    if (!this.model || !this.model.fieldRawAttributesMap) {\n      return;\n    }\n\n    for (const _field of Object.keys(this.model.fieldRawAttributesMap)) {\n      const modelField = this.model.fieldRawAttributesMap[_field];\n\n      if (modelField.type instanceof DataTypes.JSON) {\n        // Value is returned as String, not JSON\n        rows = rows.map(row => {\n          row[modelField.fieldName] = row[modelField.fieldName] ? JSON.parse(row[modelField.fieldName]) : null;\n\n          if (DataTypes.JSON.parse) {\n            return DataTypes.JSON.parse(modelField, this.sequelize.options, row[modelField.fieldName]);\n          }\n\n          return row;\n        });\n      }\n    }\n  }\n\n  async logWarnings(results) {\n    const warningResults = await this.run('SHOW WARNINGS');\n    const warningMessage = `MariaDB Warnings (${this.connection.uuid || 'default'}): `;\n    const messages = [];\n\n    for (const _warningRow of warningResults) {\n      if (_warningRow === undefined || typeof _warningRow[Symbol.iterator] !== 'function') {\n        continue;\n      }\n\n      for (const _warningResult of _warningRow) {\n        if (Object.prototype.hasOwnProperty.call(_warningResult, 'Message')) {\n          messages.push(_warningResult.Message);\n        } else {\n          for (const _objectKey of _warningResult.keys()) {\n            messages.push([_objectKey, _warningResult[_objectKey]].join(': '));\n          }\n        }\n      }\n    }\n\n    this.sequelize.log(warningMessage + messages.join('; '), this.options);\n    return results;\n  }\n\n  formatError(err) {\n    switch (err.errno) {\n      case ER_DUP_ENTRY:\n        {\n          const match = err.message.match(/Duplicate entry '([\\s\\S]*)' for key '?((.|\\s)*?)'?\\s.*$/);\n          let fields = {};\n          let message = 'Validation error';\n          const values = match ? match[1].split('-') : undefined;\n          const fieldKey = match ? match[2] : undefined;\n          const fieldVal = match ? match[1] : undefined;\n          const uniqueKey = this.model && this.model.uniqueKeys[fieldKey];\n\n          if (uniqueKey) {\n            if (uniqueKey.msg) message = uniqueKey.msg;\n            fields = _.zipObject(uniqueKey.fields, values);\n          } else {\n            fields[fieldKey] = fieldVal;\n          }\n\n          const errors = [];\n\n          _.forOwn(fields, (value, field) => {\n            errors.push(new sequelizeErrors.ValidationErrorItem(this.getUniqueConstraintErrorMessage(field), 'unique violation', // sequelizeErrors.ValidationErrorItem.Origins.DB,\n            field, value, this.instance, 'not_unique'));\n          });\n\n          return new sequelizeErrors.UniqueConstraintError({\n            message,\n            errors,\n            parent: err,\n            fields\n          });\n        }\n\n      case ER_ROW_IS_REFERENCED:\n      case ER_NO_REFERENCED_ROW:\n        {\n          // e.g. CONSTRAINT `example_constraint_name` FOREIGN KEY (`example_id`) REFERENCES `examples` (`id`)\n          const match = err.message.match(/CONSTRAINT ([`\"])(.*)\\1 FOREIGN KEY \\(\\1(.*)\\1\\) REFERENCES \\1(.*)\\1 \\(\\1(.*)\\1\\)/);\n          const quoteChar = match ? match[1] : '`';\n          const fields = match ? match[3].split(new RegExp(`${quoteChar}, *${quoteChar}`)) : undefined;\n          return new sequelizeErrors.ForeignKeyConstraintError({\n            reltype: err.errno === ER_ROW_IS_REFERENCED ? 'parent' : 'child',\n            table: match ? match[4] : undefined,\n            fields,\n            value: fields && fields.length && this.instance && this.instance[fields[0]] || undefined,\n            index: match ? match[2] : undefined,\n            parent: err\n          });\n        }\n\n      default:\n        return new sequelizeErrors.DatabaseError(err);\n    }\n  }\n\n  handleShowTablesQuery(results) {\n    return results.map(resultSet => ({\n      tableName: resultSet.TABLE_NAME,\n      schema: resultSet.TABLE_SCHEMA\n    }));\n  }\n\n  handleShowIndexesQuery(data) {\n    let currItem;\n    const result = [];\n    data.forEach(item => {\n      if (!currItem || currItem.name !== item.Key_name) {\n        currItem = {\n          primary: item.Key_name === 'PRIMARY',\n          fields: [],\n          name: item.Key_name,\n          tableName: item.Table,\n          unique: item.Non_unique !== 1,\n          type: item.Index_type\n        };\n        result.push(currItem);\n      }\n\n      currItem.fields[item.Seq_in_index - 1] = {\n        attribute: item.Column_name,\n        length: item.Sub_part || undefined,\n        order: item.Collation === 'A' ? 'ASC' : undefined\n      };\n    });\n    return result;\n  }\n\n}\n\nmodule.exports = Query;","map":{"version":3,"sources":["/Users/albab/bookapro/amazon/node_modules/sequelize/lib/dialects/mariadb/query.js"],"names":["AbstractQuery","require","sequelizeErrors","_","DataTypes","logger","ER_DUP_ENTRY","ER_DEADLOCK","ER_ROW_IS_REFERENCED","ER_NO_REFERENCED_ROW","debug","debugContext","Query","constructor","connection","sequelize","options","showWarnings","formatBindParameters","sql","values","dialect","bindParam","replacementFunc","match","key","values_","undefined","push","length","run","parameters","complete","_logQuery","results","query","error","transaction","errno","rollback","error_","finished","formatError","warningStatus","logWarnings","formatResults","data","result","instance","isBulkUpdateQuery","isBulkDeleteQuery","affectedRows","isUpsertQuery","isInsertQuery","handleInsertQuery","model","autoIncrementAttribute","primaryKeyAttribute","rawAttributes","startId","getInsertIdField","Array","pkField","field","i","isSelectQuery","handleJsonSelectQuery","handleSelectQuery","isUpdateQuery","isCallQuery","isRawQuery","meta","isShowIndexesQuery","handleShowIndexesQuery","isForeignKeysQuery","isShowConstraintsQuery","isShowTablesQuery","handleShowTablesQuery","isDescribeQuery","_result","Field","type","Type","toLowerCase","startsWith","replace","toUpperCase","allowNull","Null","defaultValue","Default","primaryKey","Key","autoIncrement","Object","prototype","hasOwnProperty","call","Extra","comment","Comment","isVersionQuery","version","rows","fieldRawAttributesMap","_field","keys","modelField","JSON","map","row","fieldName","parse","warningResults","warningMessage","uuid","messages","_warningRow","Symbol","iterator","_warningResult","Message","_objectKey","join","log","err","message","fields","split","fieldKey","fieldVal","uniqueKey","uniqueKeys","msg","zipObject","errors","forOwn","value","ValidationErrorItem","getUniqueConstraintErrorMessage","UniqueConstraintError","parent","quoteChar","RegExp","ForeignKeyConstraintError","reltype","table","index","DatabaseError","resultSet","tableName","TABLE_NAME","schema","TABLE_SCHEMA","currItem","forEach","item","name","Key_name","primary","Table","unique","Non_unique","Index_type","Seq_in_index","attribute","Column_name","Sub_part","order","Collation","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nconst AbstractQuery = require('../abstract/query');\nconst sequelizeErrors = require('../../errors');\nconst _ = require('lodash');\nconst DataTypes = require('../../data-types');\nconst { logger } = require('../../utils/logger');\n\nconst ER_DUP_ENTRY = 1062;\nconst ER_DEADLOCK = 1213;\nconst ER_ROW_IS_REFERENCED = 1451;\nconst ER_NO_REFERENCED_ROW = 1452;\n\nconst debug = logger.debugContext('sql:mariadb');\n\nclass Query extends AbstractQuery {\n  constructor(connection, sequelize, options) {\n    super(connection, sequelize, { showWarnings: false, ...options });\n  }\n\n  static formatBindParameters(sql, values, dialect) {\n    const bindParam = [];\n    const replacementFunc = (match, key, values_) => {\n      if (values_[key] !== undefined) {\n        bindParam.push(values_[key]);\n        return '?';\n      }\n      return undefined;\n    };\n    sql = AbstractQuery.formatBindParameters(sql, values, dialect, replacementFunc)[0];\n    return [sql, bindParam.length > 0 ? bindParam : undefined];\n  }\n\n  async run(sql, parameters) {\n    this.sql = sql;\n    const { connection, options } = this;\n\n    const showWarnings = this.sequelize.options.showWarnings || options.showWarnings;\n\n    const complete = this._logQuery(sql, debug, parameters);\n\n    if (parameters) {\n      debug('parameters(%j)', parameters);\n    }\n\n    let results;\n\n    try {\n      results = await connection.query(this.sql, parameters);\n    } catch (error) {\n      if (options.transaction && error.errno === ER_DEADLOCK) {\n        // MariaDB automatically rolls-back transactions in the event of a deadlock.\n        // However, we still initiate a manual rollback to ensure the connection gets released - see #13102.\n        try {\n          await options.transaction.rollback();\n        } catch (error_) {\n          // Ignore errors - since MariaDB automatically rolled back, we're\n          // not that worried about this redundant rollback failing.\n        }\n\n        options.transaction.finished = 'rollback';\n      }\n\n      error.sql = sql;\n      error.parameters = parameters;\n      throw this.formatError(error);\n    } finally {\n      complete();\n    }\n\n    if (showWarnings && results && results.warningStatus > 0) {\n      await this.logWarnings(results);\n    }\n    return this.formatResults(results);\n  }\n\n  /**\n   * High level function that handles the results of a query execution.\n   *\n   *\n   * Example:\n   *  query.formatResults([\n   *    {\n   *      id: 1,              // this is from the main table\n   *      attr2: 'snafu',     // this is from the main table\n   *      Tasks.id: 1,        // this is from the associated table\n   *      Tasks.title: 'task' // this is from the associated table\n   *    }\n   *  ])\n   *\n   * @param {Array} data - The result of the query execution.\n   * @private\n   */\n  formatResults(data) {\n    let result = this.instance;\n\n    if (this.isBulkUpdateQuery() || this.isBulkDeleteQuery()) {\n      return data.affectedRows;\n    }\n    if (this.isUpsertQuery()) {\n      return [result, data.affectedRows === 1];\n    }\n    if (this.isInsertQuery(data)) {\n      this.handleInsertQuery(data);\n\n      if (!this.instance) {\n        // handle bulkCreate AI primary key\n        if (\n          this.model\n          && this.model.autoIncrementAttribute\n          && this.model.autoIncrementAttribute === this.model.primaryKeyAttribute\n          && this.model.rawAttributes[this.model.primaryKeyAttribute]\n        ) {\n          // ONLY TRUE IF @auto_increment_increment is set to 1 !!\n          // Doesn't work with GALERA => each node will reserve increment (x for first server, x+1 for next node...)\n          const startId = data[this.getInsertIdField()];\n          result = new Array(data.affectedRows);\n          const pkField = this.model.rawAttributes[this.model.primaryKeyAttribute].field;\n          for (let i = 0; i < data.affectedRows; i++) {\n            result[i] = { [pkField]: startId + i };\n          }\n          return [result, data.affectedRows];\n        }\n\n        return [data[this.getInsertIdField()], data.affectedRows];\n      }\n    }\n\n    if (this.isSelectQuery()) {\n      this.handleJsonSelectQuery(data);\n      return this.handleSelectQuery(data);\n    }\n    if (this.isInsertQuery() || this.isUpdateQuery()) {\n      return [result, data.affectedRows];\n    }\n    if (this.isCallQuery()) {\n      return data[0];\n    }\n    if (this.isRawQuery()) {\n      const meta = data.meta;\n      delete data.meta;\n      return [data, meta];\n    }\n    if (this.isShowIndexesQuery()) {\n      return this.handleShowIndexesQuery(data);\n    }\n    if (this.isForeignKeysQuery() || this.isShowConstraintsQuery()) {\n      return data;\n    }\n    if (this.isShowTablesQuery()) {\n      return this.handleShowTablesQuery(data);\n    }\n    if (this.isDescribeQuery()) {\n      result = {};\n\n      for (const _result of data) {\n        result[_result.Field] = {\n          type: _result.Type.toLowerCase().startsWith('enum') ? _result.Type.replace(/^enum/i,\n            'ENUM') : _result.Type.toUpperCase(),\n          allowNull: _result.Null === 'YES',\n          defaultValue: _result.Default,\n          primaryKey: _result.Key === 'PRI',\n          autoIncrement: Object.prototype.hasOwnProperty.call(_result, 'Extra')\n            && _result.Extra.toLowerCase() === 'auto_increment',\n          comment: _result.Comment ? _result.Comment : null\n        };\n      }\n      return result;\n    }\n    if (this.isVersionQuery()) {\n      return data[0].version;\n    }\n\n    return result;\n  }\n\n  handleJsonSelectQuery(rows) {\n    if (!this.model || !this.model.fieldRawAttributesMap) {\n      return;\n    }\n    for (const _field of Object.keys(this.model.fieldRawAttributesMap)) {\n      const modelField = this.model.fieldRawAttributesMap[_field];\n      if (modelField.type instanceof DataTypes.JSON) {\n        // Value is returned as String, not JSON\n        rows = rows.map(row => {\n          row[modelField.fieldName] = row[modelField.fieldName] ? JSON.parse(\n            row[modelField.fieldName]) : null;\n          if (DataTypes.JSON.parse) {\n            return DataTypes.JSON.parse(modelField, this.sequelize.options,\n              row[modelField.fieldName]);\n          }\n          return row;\n        });\n      }\n    }\n  }\n\n  async logWarnings(results) {\n    const warningResults = await this.run('SHOW WARNINGS');\n    const warningMessage = `MariaDB Warnings (${this.connection.uuid || 'default'}): `;\n    const messages = [];\n    for (const _warningRow of warningResults) {\n      if (_warningRow === undefined || typeof _warningRow[Symbol.iterator] !== 'function') {\n        continue;\n      }\n      for (const _warningResult of _warningRow) {\n        if (Object.prototype.hasOwnProperty.call(_warningResult, 'Message')) {\n          messages.push(_warningResult.Message);\n        } else {\n          for (const _objectKey of _warningResult.keys()) {\n            messages.push([_objectKey, _warningResult[_objectKey]].join(': '));\n          }\n        }\n      }\n    }\n\n    this.sequelize.log(warningMessage + messages.join('; '), this.options);\n\n    return results;\n  }\n\n  formatError(err) {\n    switch (err.errno) {\n      case ER_DUP_ENTRY: {\n        const match = err.message.match(\n          /Duplicate entry '([\\s\\S]*)' for key '?((.|\\s)*?)'?\\s.*$/);\n\n        let fields = {};\n        let message = 'Validation error';\n        const values = match ? match[1].split('-') : undefined;\n        const fieldKey = match ? match[2] : undefined;\n        const fieldVal = match ? match[1] : undefined;\n        const uniqueKey = this.model && this.model.uniqueKeys[fieldKey];\n\n        if (uniqueKey) {\n          if (uniqueKey.msg) message = uniqueKey.msg;\n          fields = _.zipObject(uniqueKey.fields, values);\n        } else {\n          fields[fieldKey] = fieldVal;\n        }\n\n        const errors = [];\n        _.forOwn(fields, (value, field) => {\n          errors.push(new sequelizeErrors.ValidationErrorItem(\n            this.getUniqueConstraintErrorMessage(field),\n            'unique violation', // sequelizeErrors.ValidationErrorItem.Origins.DB,\n            field,\n            value,\n            this.instance,\n            'not_unique'\n          ));\n        });\n\n        return new sequelizeErrors.UniqueConstraintError({ message, errors, parent: err, fields });\n      }\n\n      case ER_ROW_IS_REFERENCED:\n      case ER_NO_REFERENCED_ROW: {\n        // e.g. CONSTRAINT `example_constraint_name` FOREIGN KEY (`example_id`) REFERENCES `examples` (`id`)\n        const match = err.message.match(\n          /CONSTRAINT ([`\"])(.*)\\1 FOREIGN KEY \\(\\1(.*)\\1\\) REFERENCES \\1(.*)\\1 \\(\\1(.*)\\1\\)/\n        );\n        const quoteChar = match ? match[1] : '`';\n        const fields = match ? match[3].split(new RegExp(`${quoteChar}, *${quoteChar}`)) : undefined;\n\n        return new sequelizeErrors.ForeignKeyConstraintError({\n          reltype: err.errno === ER_ROW_IS_REFERENCED ? 'parent' : 'child',\n          table: match ? match[4] : undefined,\n          fields,\n          value: fields && fields.length && this.instance && this.instance[fields[0]] || undefined,\n          index: match ? match[2] : undefined,\n          parent: err\n        });\n      }\n\n      default:\n        return new sequelizeErrors.DatabaseError(err);\n    }\n  }\n\n  handleShowTablesQuery(results) {\n    return results.map(resultSet => ({\n      tableName: resultSet.TABLE_NAME,\n      schema: resultSet.TABLE_SCHEMA\n    }));\n  }\n\n  handleShowIndexesQuery(data) {\n\n    let currItem;\n    const result = [];\n\n    data.forEach(item => {\n      if (!currItem || currItem.name !== item.Key_name) {\n        currItem = {\n          primary: item.Key_name === 'PRIMARY',\n          fields: [],\n          name: item.Key_name,\n          tableName: item.Table,\n          unique: item.Non_unique !== 1,\n          type: item.Index_type\n        };\n        result.push(currItem);\n      }\n\n      currItem.fields[item.Seq_in_index - 1] = {\n        attribute: item.Column_name,\n        length: item.Sub_part || undefined,\n        order: item.Collation === 'A' ? 'ASC' : undefined\n      };\n    });\n\n    return result;\n  }\n}\n\nmodule.exports = Query;\n"]},"metadata":{},"sourceType":"script"}